<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlySphere - Staff Portal</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" href="favicon/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/site.webmanifest">
</head>
<body>
    <nav>
        <div class="logo">
            <h1>FlySphere</h1>
        </div>
        <div class="hamburger">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
        <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
            <i class="fas fa-sun"></i>
        </button>
        <ul class="nav-links">
            <li><a href="index.html#home">Home</a></li>
            <li><a href="index.html#about">About</a></li>
            <li><a href="index.html#features">Features</a></li>
            <li><a href="index.html#updates">Updates</a></li>
            <li><a href="index.html#play">Play</a></li>
            <li><a href="index.html#community">Community</a></li>
            <li><a href="#" class="active">Staff Portal</a></li>
        </ul>
    </nav>

    <section id="staff-portal">
        <h2>Staff Portal</h2>
        <div id="login-section">
            <div class="login-container">
                <h3>Staff Login</h3>
                <div class="login-form">
                    <input type="email" id="email" placeholder="Email" required aria-label="Email">
                    <input type="password" id="password" placeholder="Password" required aria-label="Password">
                    <button class="cta-button" onclick="login()">Login</button>
                </div>
                <p id="login-error" style="color: #DC3545; display: none;" aria-live="polite"></p>
            </div>
        </div>
        <div id="staff-content" style="display: none;">
            <div class="data-controls">
                <button class="small-cta" onclick="logout()">Logout</button>
            </div>
            <div id="admin-controls" style="display: none;">
                <h3>Admin Controls</h3>
                <div class="admin-section">
                    <h4>Manage Staff Accounts</h4>
                    <div class="form-group">
                        <input type="email" id="new-staff-email" placeholder="New Staff Email" required aria-label="New Staff Email">
                        <input type="password" id="new-staff-password" placeholder="New Staff Password" required aria-label="New Staff Password">
                        <select id="new-staff-role" required aria-label="New Staff Role">
                            <option value="staff">Staff</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button class="small-cta" onclick="signUp()">Create Account</button>
                    </div>
                    <p id="signup-error" style="color: #DC3545; display: none;" aria-live="polite"></p>
                </div>
                <div class="admin-section">
                    <h4>Manage Schedules</h4>
                    <div class="form-group">
                        <input type="text" id="schedule-staff" placeholder="Staff Name" required aria-label="Staff Name">
                        <input type="date" id="schedule-date" required aria-label="Schedule Date">
                        <input type="time" id="schedule-time" required aria-label="Schedule Time">
                        <input type="text" id="schedule-task" placeholder="Task" required aria-label="Task">
                        <button class="small-cta" onclick="addSchedule()">Add Schedule</button>
                    </div>
                </div>
                <div class="admin-section">
                    <h4>Manage Events</h4>
                    <div class="form-group">
                        <input type="text" id="event-title" placeholder="Event Title" required aria-label="Event Title">
                        <input type="date" id="event-date" required aria-label="Event Date">
                        <input type="time" id="event-time" required aria-label="Event Time">
                        <input type="text" id="event-location" placeholder="Location" required aria-label="Location">
                        <button class="small-cta" onclick="addEvent()">Add Event</button>
                    </div>
                </div>
                <div class="admin-section">
                    <h4>Manage Leave of Absence</h4>
                    <div class="form-group">
                        <input type="text" id="leave-staff" placeholder="Staff Name" required aria-label="Staff Name">
                        <input type="date" id="leave-start-date" required aria-label="Start Date">
                        <input type="date" id="leave-end-date" required aria-label="End Date">
                        <input type="text" id="leave-reason" placeholder="Reason" required aria-label="Reason">
                        <button class="small-cta" onclick="addLeave()">Add Leave</button>
                    </div>
                </div>
            </div>
            <div id="staff-controls" style="display: none;">
                <h3>Staff Actions</h3>
                <div class="staff-section">
                    <h4>Request Leave of Absence</h4>
                    <div class="form-group">
                        <input type="text" id="request-leave-staff" placeholder="Your Name" required aria-label="Staff Name">
                        <input type="date" id="request-leave-start-date" required aria-label="Start Date">
                        <input type="date" id="request-leave-end-date" required aria-label="End Date">
                        <input type="text" id="request-leave-reason" placeholder="Reason" required aria-label="Reason">
                        <button class="small-cta" onclick="requestLeave()">Request Leave</button>
                    </div>
                </div>
            </div>
            <h3>Schedules</h3>
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>Staff Name</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Task</th>
                        <th>Created By</th>
                        <th>Created At</th>
                        <th>Modified By</th>
                        <th>Modified At</th>
                        <th class="admin-only" style="display: none;">Actions</th>
                    </tr>
                </thead>
                <tbody id="schedule-table"></tbody>
            </table>
            <h3>Upcoming Events</h3>
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Location</th>
                        <th>Created By</th>
                        <th>Created At</th>
                        <th>Modified By</th>
                        <th>Modified At</th>
                        <th class="admin-only" style="display: none;">Actions</th>
                    </tr>
                </thead>
                <tbody id="event-table"></tbody>
            </table>
            <h3>Leave of Absence</h3>
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>Staff Name</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Reason</th>
                        <th>Created By</th>
                        <th>Created At</th>
                        <th>Modified By</th>
                        <th>Modified At</th>
                        <th class="admin-only" style="display: none;">Actions</th>
                    </tr>
                </thead>
                <tbody id="leave-table"></tbody>
            </table>
            <div class="sync-status">
                <span id="sync-status"></span>
            </div>
        </div>
    </section>

    <footer>
        <p>Â© 2025 <a href="https://www.roblox.com/groups/34437147/FlySphere#!/about" target="_blank" class="footer-links">FlySphere</a> <a href="https://www.roblox.com/users/5428730337/profile" target="_blank" class="footer-links">[MrTacoGaming76]</a> - Your Virtual Airline on Roblox</p>
    </footer>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, deleteDoc, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCXbjnQqzxIy1bbQ-lrleUUT1EnRzvNPPY",
            authDomain: "flysphere-75c1c.firebaseapp.com",
            projectId: "flysphere-75c1c",
            storageBucket: "flysphere-75c1c.appspot.com",
            messagingSenderId: "582235400495",
            appId: "1:582235400495:web:5e28919ffeae4cf41e59da"
        };

        // Initialize Firebase
        let auth, db;
        let firebaseInitialized = false;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            firebaseInitialized = true;
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Error initializing Firebase:', error);
            alert('Failed to connect to Firebase. Please check your network and try again.');
        }

        // Theme toggle
        document.getElementById('theme-toggle').addEventListener('click', () => {
            console.log('Theme toggle clicked');
            try {
                document.documentElement.classList.toggle('dark-mode');
                document.documentElement.classList.toggle('light-mode');
                const theme = document.documentElement.classList.contains('dark-mode') ? 'dark' : 'light';
                localStorage.setItem('theme', theme);
                console.log('Theme set to:', theme);
            } catch (error) {
                console.error('Error in theme toggle:', error);
            }
        });

        // Hamburger menu
        const hamburger = document.querySelector('.hamburger');
        const navLinks = document.querySelector('.nav-links');
        if (hamburger && navLinks) {
            hamburger.addEventListener('click', () => {
                console.log('Hamburger clicked');
                try {
                    if (window.innerWidth <= 768) {
                        navLinks.classList.toggle('active');
                        hamburger.classList.toggle('active');
                        console.log('Nav links toggled:', navLinks.classList.contains('active'));
                    }
                } catch (error) {
                    console.error('Error in hamburger toggle:', error);
                }
            });

            navLinks.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    console.log('Nav link clicked:', link.textContent);
                    if (window.innerWidth <= 768) {
                        navLinks.classList.remove('active');
                        hamburger.classList.remove('active');
                        console.log('Menu closed after link click');
                    }
                });
            });
        } else {
            console.error('Hamburger or nav-links not found');
        }

        // Disable right-click and source view
        document.addEventListener('contextmenu', e => {
            console.log('Right-click prevented');
            e.preventDefault();
        });
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && (e.key === 'u' || e.key === 'U' || e.key === 'i' || e.key === 'I') || e.key === 'F12') {
                console.log('Source view prevented');
                e.preventDefault();
            }
        });

        // Firebase-dependent functions
        if (firebaseInitialized) {
            // Check auth state
            if (typeof onAuthStateChanged === 'function') {
                onAuthStateChanged(auth, async user => {
                    console.log('onAuthStateChanged triggered:', user ? user.email : 'No user');
                    try {
                        const loginSection = document.getElementById('login-section');
                        const staffContent = document.getElementById('staff-content');
                        const adminControls = document.getElementById('admin-controls');
                        const staffControls = document.getElementById('staff-controls');
                        const adminOnlyElements = document.querySelectorAll('.admin-only');
                        const syncStatus = document.getElementById('sync-status');

                        console.log('Checking DOM elements...');
                        if (!loginSection || !staffContent || !adminControls || !staffControls || !syncStatus) {
                            console.error('DOM elements missing:', {
                                loginSection: !!loginSection,
                                staffContent: !!staffContent,
                                adminControls: !!adminControls,
                                staffControls: !!staffControls,
                                syncStatus: !!syncStatus
                            });
                            return;
                        }

                        if (user) {
                            console.log('User authenticated, updating UI...');
                            loginSection.style.display = 'none';
                            staffContent.style.display = 'block';
                            syncStatus.textContent = 'Syncing...';

                            console.log('Fetching user role for UID:', user.uid);
                            let isAdmin = false;
                            try {
                                const userDoc = await getDoc(doc(db, 'users', user.uid));
                                isAdmin = userDoc.exists() && userDoc.data().role === 'admin';
                                console.log('User role fetched:', isAdmin ? 'admin' : 'staff');
                            } catch (error) {
                                console.error('Error fetching user role:', error);
                                isAdmin = false;
                            }

                            if (isAdmin) {
                                console.log('Showing admin controls');
                                adminControls.style.display = 'block';
                                staffControls.style.display = 'none';
                                adminOnlyElements.forEach(el => el.style.display = 'table-cell');
                            } else {
                                console.log('Showing staff controls');
                                adminControls.style.display = 'none';
                                staffControls.style.display = 'block';
                                adminOnlyElements.forEach(el => el.style.display = 'none');
                            }

                            console.log('Loading tables...');
                            loadTables(user.email, isAdmin);
                            // Sync status updated in loadTables
                        } else {
                            console.log('No user, showing login section');
                            loginSection.style.display = 'block';
                            staffContent.style.display = 'none';
                            adminControls.style.display = 'none';
                            staffControls.style.display = 'none';
                            adminOnlyElements.forEach(el => el.style.display = 'none');
                            syncStatus.textContent = '';
                        }
                    } catch (error) {
                        console.error('Error in onAuthStateChanged:', error);
                    }
                });
            } else {
                console.error('onAuthStateChanged is not defined');
                alert('Firebase Authentication failed to load. Please refresh the page.');
            }

            // Login
            window.login = function() {
                console.log('Login button clicked');
                try {
                    const emailInput = document.getElementById('email');
                    const passwordInput = document.getElementById('password');
                    const errorElement = document.getElementById('login-error');

                    if (!emailInput || !passwordInput || !errorElement) {
                        console.error('Login form elements not found');
                        return;
                    }

                    const email = emailInput.value.trim();
                    const password = passwordInput.value;

                    if (!email || !password) {
                        errorElement.textContent = 'Please enter both email and password.';
                        errorElement.style.display = 'block';
                        return;
                    }

                    console.log('Attempting login for:', email);
                    signInWithEmailAndPassword(auth, email, password)
                        .then(userCredential => {
                            console.log('Login successful:', userCredential.user.email);
                            errorElement.style.display = 'none';
                            emailInput.value = '';
                            passwordInput.value = '';
                            console.log('Forcing auth state check...');
                            if (auth.currentUser) {
                                console.log('Current user detected:', auth.currentUser.email);
                                document.getElementById('login-section').style.display = 'none';
                                document.getElementById('staff-content').style.display = 'block';
                                document.getElementById('sync-status').textContent = 'Syncing...';
                            }
                        })
                        .catch(error => {
                            console.error('Login error:', error.code, error.message);
                            let message = error.message;
                            if (error.code === 'auth/invalid-credential') {
                                message = 'Invalid email or password. Please try again.';
                            } else if (error.code === 'auth/user-not-found') {
                                message = 'No user found with this email.';
                            } else if (error.code === 'auth/invalid-email') {
                                message = 'Invalid email format.';
                            } else if (error.code === 'auth/too-many-requests') {
                                message = 'Too many attempts. Please try again later.';
                            }
                            errorElement.textContent = message;
                            errorElement.style.display = 'block';
                            emailInput.value = '';
                            passwordInput.value = '';
                        });
                } catch (error) {
                    console.error('Unexpected error in login:', error);
                }
            };

            // Sign Up (Admin Only)
            window.signUp = async function() {
                console.log('Sign Up button clicked');
                try {
                    const emailInput = document.getElementById('new-staff-email');
                    const passwordInput = document.getElementById('new-staff-password');
                    const roleInput = document.getElementById('new-staff-role');
                    const errorElement = document.getElementById('signup-error');

                    if (!emailInput || !passwordInput || !roleInput || !errorElement) {
                        console.error('Sign-up form elements not found');
                        return;
                    }

                    const user = auth.currentUser;
                    if (!user) {
                        errorElement.textContent = 'You must be logged in to create accounts.';
                        errorElement.style.display = 'block';
                        return;
                    }
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (!userDoc.exists() || userDoc.data().role !== 'admin') {
                        errorElement.textContent = 'Only admins can create new accounts.';
                        errorElement.style.display = 'block';
                        return;
                    }

                    const email = emailInput.value.trim();
                    const password = passwordInput.value;
                    const role = roleInput.value;

                    if (!email || !password || !role) {
                        errorElement.textContent = 'Please fill all fields.';
                        errorElement.style.display = 'block';
                        return;
                    }

                    console.log('Creating account for:', email);
                    createUserWithEmailAndPassword(auth, email, password)
                        .then(userCredential => {
                            console.log('Account created:', email);
                            return setDoc(doc(db, 'users', userCredential.user.uid), {
                                email: email,
                                role: role
                            });
                        })
                        .then(() => {
                            errorElement.style.display = 'none';
                            emailInput.value = '';
                            passwordInput.value = '';
                            roleInput.value = 'staff';
                            alert('Account created successfully!');
                        })
                        .catch(error => {
                            console.error('Sign-up error:', error.code, error.message);
                            let message = error.message;
                            if (error.code === 'auth/email-already-in-use') {
                                message = 'This email is already registered.';
                            } else if (error.code === 'auth/invalid-email') {
                                message = 'Invalid email format.';
                            } else if (error.code === 'auth/weak-password') {
                                message = 'Password is too weak. Use at least 6 characters.';
                            }
                            errorElement.textContent = message;
                            errorElement.style.display = 'block';
                        });
                } catch (error) {
                    console.error('Unexpected error in signUp:', error);
                }
            };

            // Logout
            window.logout = function() {
                console.log('Logout clicked');
                try {
                    signOut(auth).then(() => {
                        console.log('Logged out');
                        document.getElementById('email').value = '';
                        document.getElementById('password').value = '';
                    }).catch(error => {
                        console.error('Logout error:', error);
                    });
                } catch (error) {
                    console.error('Error in logout:', error);
                }
            };

            // Format timestamp
            function formatTimestamp(timestamp) {
                if (!timestamp) return '';
                try {
                    const date = timestamp.toDate();
                    return date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                } catch (error) {
                    console.error('Error formatting timestamp:', error);
                    return '';
                }
            }

            // Load tables with real-time listeners
            async function loadTables(userEmail, isAdmin) {
                console.log('Loading tables');
                try {
                    const scheduleTable = document.getElementById('schedule-table');
                    const eventTable = document.getElementById('event-table');
                    const leaveTable = document.getElementById('leave-table');
                    const syncStatus = document.getElementById('sync-status');

                    if (!scheduleTable || !eventTable || !leaveTable || !syncStatus) {
                        console.error('Table elements not found', {
                            scheduleTable: !!scheduleTable,
                            eventTable: !!eventTable,
                            leaveTable: !!leaveTable,
                            syncStatus: !!syncStatus
                        });
                        return;
                    }

                    let syncStates = {
                        schedules: false,
                        events: false,
                        leaves: false
                    };
                    let lastSyncTime = null;

                    function updateSyncStatus() {
                        if (!syncStates.schedules || !syncStates.events || !syncStates.leaves) {
                            syncStatus.textContent = 'Syncing...';
                        } else {
                            lastSyncTime = new Date();
                            syncStatus.textContent = `Last synced: ${lastSyncTime.toLocaleString('en-US', {
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: true
                            })}`;
                        }
                    }

                    // Real-time schedules
                    onSnapshot(collection(db, 'schedules'), orderBy('date'), snapshot => {
                        try {
                            scheduleTable.innerHTML = '';
                            snapshot.forEach(doc => {
                                const schedule = doc.data();
                                const row = document.createElement('tr');
                                row.classList.add('fade-in');
                                row.innerHTML = `
                                    <td>${schedule.staff || ''}</td>
                                    <td>${schedule.date || ''}</td>
                                    <td>${schedule.time || ''}</td>
                                    <td>${schedule.task || ''}</td>
                                    <td>${schedule.createdBy || ''}</td>
                                    <td>${formatTimestamp(schedule.createdAt)}</td>
                                    <td>${schedule.modifiedBy || ''}</td>
                                    <td>${formatTimestamp(schedule.modifiedAt)}</td>
                                    <td class="admin-only" style="display: ${isAdmin ? 'table-cell' : 'none'};">
                                        <button class="small-cta" onclick="editSchedule('${doc.id}')">Edit</button>
                                        <button class="small-cta" onclick="deleteSchedule('${doc.id}')">Delete</button>
                                    </td>
                                `;
                                scheduleTable.appendChild(row);
                            });
                            syncStates.schedules = true;
                            updateSyncStatus();
                        } catch (error) {
                            console.error('Error in schedules snapshot:', error);
                            syncStatus.textContent = 'Sync failed';
                        }
                    }, error => {
                        console.error('Schedules listener error:', error);
                        syncStatus.textContent = 'Sync failed';
                        syncStates.schedules = false;
                    });

                    // Real-time events
                    onSnapshot(collection(db, 'events'), orderBy('date'), snapshot => {
                        try {
                            eventTable.innerHTML = '';
                            snapshot.forEach(doc => {
                                const event = doc.data();
                                const row = document.createElement('tr');
                                row.classList.add('fade-in');
                                row.innerHTML = `
                                    <td>${event.title || ''}</td>
                                    <td>${event.date || ''}</td>
                                    <td>${event.time || ''}</td>
                                    <td>${event.location || ''}</td>
                                    <td>${event.createdBy || ''}</td>
                                    <td>${formatTimestamp(event.createdAt)}</td>
                                    <td>${event.modifiedBy || ''}</td>
                                    <td>${formatTimestamp(event.modifiedAt)}</td>
                                    <td class="admin-only" style="display: ${isAdmin ? 'table-cell' : 'none'};">
                                        <button class="small-cta" onclick="editEvent('${doc.id}')">Edit</button>
                                        <button class="small-cta" onclick="deleteEvent('${doc.id}')">Delete</button>
                                    </td>
                                `;
                                eventTable.appendChild(row);
                            });
                            syncStates.events = true;
                            updateSyncStatus();
                        } catch (error) {
                            console.error('Error in events snapshot:', error);
                            syncStatus.textContent = 'Sync failed';
                        }
                    }, error => {
                        console.error('Events listener error:', error);
                        syncStatus.textContent = 'Sync failed';
                        syncStates.events = false;
                    });

                    // Real-time leaves
                    onSnapshot(collection(db, 'leaves'), orderBy('startDate'), snapshot => {
                        try {
                            leaveTable.innerHTML = '';
                            snapshot.forEach(doc => {
                                const leave = doc.data();
                                if (isAdmin || leave.createdBy === userEmail) {
                                    const row = document.createElement('tr');
                                    row.classList.add('fade-in');
                                    row.innerHTML = `
                                        <td>${leave.staff || ''}</td>
                                        <td>${leave.startDate || ''}</td>
                                        <td>${leave.endDate || ''}</td>
                                        <td>${leave.reason || ''}</td>
                                        <td>${leave.createdBy || ''}</td>
                                        <td>${formatTimestamp(leave.createdAt)}</td>
                                        <td>${leave.modifiedBy || ''}</td>
                                        <td>${formatTimestamp(leave.modifiedAt)}</td>
                                        <td class="admin-only" style="display: ${isAdmin ? 'table-cell' : 'none'};">
                                            <button class="small-cta" onclick="editLeave('${doc.id}')">Edit</button>
                                            <button class="small-cta" onclick="deleteLeave('${doc.id}')">Delete</button>
                                        </td>
                                    `;
                                    leaveTable.appendChild(row);
                                }
                            });
                            syncStates.leaves = true;
                            updateSyncStatus();
                        } catch (error) {
                            console.error('Error in leaves snapshot:', error);
                            syncStatus.textContent = 'Sync failed';
                        }
                    }, error => {
                        console.error('Leaves listener error:', error);
                        syncStatus.textContent = 'Sync failed';
                        syncStates.leaves = false;
                    });
                } catch (error) {
                    console.error('Error in loadTables:', error);
                    document.getElementById('sync-status').textContent = 'Sync failed';
                }
            }

            // Add schedule
            window.addSchedule = function() {
                console.log('Add schedule clicked');
                try {
                    const staffInput = document.getElementById('schedule-staff');
                    const dateInput = document.getElementById('schedule-date');
                    const timeInput = document.getElementById('schedule-time');
                    const taskInput = document.getElementById('schedule-task');

                    if (!staffInput || !dateInput || !timeInput || !taskInput) {
                        console.error('Schedule form elements not found');
                        return;
                    }

                    const staff = staffInput.value.trim();
                    const date = dateInput.value;
                    const time = timeInput.value;
                    const task = taskInput.value.trim();

                    if (staff && date && time && task) {
                        addDoc(collection(db, 'schedules'), {
                            staff,
                            date,
                            time,
                            task,
                            createdBy: auth.currentUser.email,
                            createdAt: serverTimestamp(),
                            modifiedBy: auth.currentUser.email,
                            modifiedAt: serverTimestamp()
                        }).then(() => {
                            console.log('Schedule added:', { staff, date, time, task });
                            clearForm('schedule');
                        }).catch(error => {
                            console.error('Error adding schedule:', error);
                            alert('Failed to add schedule. Please try again.');
                        });
                    } else {
                        alert('Please fill all fields.');
                    }
                } catch (error) {
                    console.error('Error in addSchedule:', error);
                    alert('Failed to add schedule. Please try again.');
                }
            };

            // Add event
            window.addEvent = function() {
                console.log('Add event clicked');
                try {
                    const titleInput = document.getElementById('event-title');
                    const dateInput = document.getElementById('event-date');
                    const timeInput = document.getElementById('event-time');
                    const locationInput = document.getElementById('event-location');

                    if (!titleInput || !dateInput || !timeInput || !locationInput) {
                        console.error('Event form elements not found');
                        return;
                    }

                    const title = titleInput.value.trim();
                    const date = dateInput.value;
                    const time = timeInput.value;
                    const location = locationInput.value.trim();

                    if (title && date && time && location) {
                        addDoc(collection(db, 'events'), {
                            title,
                            date,
                            time,
                            location,
                            createdBy: auth.currentUser.email,
                            createdAt: serverTimestamp(),
                            modifiedBy: auth.currentUser.email,
                            modifiedAt: serverTimestamp()
                        }).then(() => {
                            console.log('Event added:', { title, date, time, location });
                            clearForm('event');
                        }).catch(error => {
                            console.error('Error adding event:', error);
                            alert('Failed to add event. Please try again.');
                        });
                    } else {
                        alert('Please fill all fields.');
                    }
                } catch (error) {
                    console.error('Error in addEvent:', error);
                    alert('Failed to add event. Please try again.');
                }
            };

            // Add leave (Admin Only)
            window.addLeave = function() {
                console.log('Add leave clicked');
                try {
                    const staffInput = document.getElementById('leave-staff');
                    const startDateInput = document.getElementById('leave-start-date');
                    const endDateInput = document.getElementById('leave-end-date');
                    const reasonInput = document.getElementById('leave-reason');

                    if (!staffInput || !startDateInput || !endDateInput || !reasonInput) {
                        console.error('Leave form elements not found');
                        return;
                    }

                    const staff = staffInput.value.trim();
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    const reason = reasonInput.value.trim();

                    if (staff && startDate && endDate && reason) {
                        addDoc(collection(db, 'leaves'), {
                            staff,
                            startDate,
                            endDate,
                            reason,
                            createdBy: auth.currentUser.email,
                            createdAt: serverTimestamp(),
                            modifiedBy: auth.currentUser.email,
                            modifiedAt: serverTimestamp()
                        }).then(() => {
                            console.log('Leave added:', { staff, startDate, endDate, reason });
                            clearForm('leave');
                        }).catch(error => {
                            console.error('Error adding leave:', error);
                            alert('Failed to add leave. Please try again.');
                        });
                    } else {
                        alert('Please fill all fields.');
                    }
                } catch (error) {
                    console.error('Error in addLeave:', error);
                    alert('Failed to add leave. Please try again.');
                }
            };

            // Request leave (Staff)
            window.requestLeave = function() {
                console.log('Request leave clicked');
                try {
                    const staffInput = document.getElementById('request-leave-staff');
                    const startDateInput = document.getElementById('request-leave-start-date');
                    const endDateInput = document.getElementById('request-leave-end-date');
                    const reasonInput = document.getElementById('request-leave-reason');

                    if (!staffInput || !startDateInput || !endDateInput || !reasonInput) {
                        console.error('Request leave form elements not found');
                        return;
                    }

                    const staff = staffInput.value.trim();
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    const reason = reasonInput.value.trim();

                    if (staff && startDate && endDate && reason) {
                        addDoc(collection(db, 'leaves'), {
                            staff,
                            startDate,
                            endDate,
                            reason,
                            createdBy: auth.currentUser.email,
                            createdAt: serverTimestamp(),
                            modifiedBy: auth.currentUser.email,
                            modifiedAt: serverTimestamp()
                        }).then(() => {
                            console.log('Leave requested:', { staff, startDate, endDate, reason });
                            clearForm('request-leave');
                        }).catch(error => {
                            console.error('Error requesting leave:', error);
                            alert('Failed to request leave. Please try again.');
                        });
                    } else {
                        alert('Please fill all fields.');
                    }
                } catch (error) {
                    console.error('Error in requestLeave:', error);
                    alert('Failed to request leave. Please try again.');
                }
            };

            // Edit schedule
            window.editSchedule = function(id) {
                console.log('Edit schedule:', id);
                try {
                    getDoc(doc(db, 'schedules', id)).then(doc => {
                        if (doc.exists()) {
                            const schedule = doc.data();
                            const staffInput = document.getElementById('schedule-staff');
                            const dateInput = document.getElementById('schedule-date');
                            const timeInput = document.getElementById('schedule-time');
                            const taskInput = document.getElementById('schedule-task');

                            if (staffInput && dateInput && timeInput && taskInput) {
                                staffInput.value = schedule.staff || '';
                                dateInput.value = schedule.date || '';
                                timeInput.value = schedule.time || '';
                                taskInput.value = schedule.task || '';
                                deleteDoc(doc(db, 'schedules', id)).then(() => {
                                    console.log('Schedule prepared for edit:', id);
                                }).catch(error => {
                                    console.error('Error deleting schedule for edit:', error);
                                    alert('Failed to edit schedule. Please try again.');
                                });
                            }
                        }
                    }).catch(error => {
                        console.error('Error fetching schedule:', error);
                        alert('Failed to edit schedule. Please try again.');
                    });
                } catch (error) {
                    console.error('Error in editSchedule:', error);
                    alert('Failed to edit schedule. Please try again.');
                }
            };

            // Delete schedule
            window.deleteSchedule = function(id) {
                console.log('Delete schedule:', id);
                try {
                    if (confirm('Are you sure you want to delete this schedule?')) {
                        deleteDoc(doc(db, 'schedules', id)).then(() => {
                            console.log('Schedule deleted:', id);
                        }).catch(error => {
                            console.error('Error deleting schedule:', error);
                            alert('Failed to delete schedule. Please try again.');
                        });
                    }
                } catch (error) {
                    console.error('Error in deleteSchedule:', error);
                    alert('Failed to delete schedule. Please try again.');
                }
            };

            // Edit event
            window.editEvent = function(id) {
                console.log('Edit event:', id);
                try {
                    getDoc(doc(db, 'events', id)).then(doc => {
                        if (doc.exists()) {
                            const event = doc.data();
                            const titleInput = document.getElementById('event-title');
                            const dateInput = document.getElementById('event-date');
                            const timeInput = document.getElementById('event-time');
                            const locationInput = document.getElementById('event-location');

                            if (titleInput && dateInput && timeInput && locationInput) {
                                titleInput.value = event.title || '';
                                dateInput.value = event.date || '';
                                timeInput.value = event.time || '';
                                locationInput.value = event.location || '';
                                deleteDoc(doc(db, 'events', id)).then(() => {
                                    console.log('Event prepared for edit:', id);
                                }).catch(error => {
                                    console.error('Error deleting event for edit:', error);
                                    alert('Failed to edit event. Please try again.');
                                });
                            }
                        }
                    }).catch(error => {
                        console.error('Error fetching event:', error);
                        alert('Failed to edit event. Please try again.');
                    });
                } catch (error) {
                    console.error('Error in editEvent:', error);
                    alert('Failed to edit event. Please try again.');
                }
            };

            // Delete event
            window.deleteEvent = function(id) {
                console.log('Delete event:', id);
                try {
                    if (confirm('Are you sure you want to delete this event?')) {
                        deleteDoc(doc(db, 'events', id)).then(() => {
                            console.log('Event deleted:', id);
                        }).catch(error => {
                            console.error('Error deleting event:', error);
                            alert('Failed to delete event. Please try again.');
                        });
                    }
                } catch (error) {
                    console.error('Error in deleteEvent:', error);
                    alert('Failed to delete event. Please try again.');
                }
            };

            // Edit leave
            window.editLeave = function(id) {
                console.log('Edit leave:', id);
                try {
                    getDoc(doc(db, 'leaves', id)).then(doc => {
                        if (doc.exists()) {
                            const leave = doc.data();
                            const staffInput = document.getElementById('leave-staff');
                            const startDateInput = document.getElementById('leave-start-date');
                            const endDateInput = document.getElementById('leave-end-date');
                            const reasonInput = document.getElementById('leave-reason');

                            if (staffInput && startDateInput && endDateInput && reasonInput) {
                                staffInput.value = leave.staff || '';
                                startDateInput.value = leave.startDate || '';
                                endDateInput.value = leave.endDate || '';
                                reasonInput.value = leave.reason || '';
                                deleteDoc(doc(db, 'leaves', id)).then(() => {
                                    console.log('Leave prepared for edit:', id);
                                }).catch(error => {
                                    console.error('Error deleting leave for edit:', error);
                                    alert('Failed to edit leave. Please try again.');
                                });
                            }
                        }
                    }).catch(error => {
                        console.error('Error fetching leave:', error);
                        alert('Failed to edit leave. Please try again.');
                    });
                } catch (error) {
                    console.error('Error in editLeave:', error);
                    alert('Failed to edit leave. Please try again.');
                }
            };

            // Delete leave
            window.deleteLeave = function(id) {
                console.log('Delete leave:', id);
                try {
                    if (confirm('Are you sure you want to delete this leave record?')) {
                        deleteDoc(doc(db, 'leaves', id)).then(() => {
                            console.log('Leave deleted:', id);
                        }).catch(error => {
                            console.error('Error deleting leave:', error);
                            alert('Failed to delete leave. Please try again.');
                        });
                    }
                } catch (error) {
                    console.error('Error in deleteLeave:', error);
                    alert('Failed to delete leave. Please try again.');
                }
            };

            // Clear form
            window.clearForm = function(type) {
                console.log('Clearing form:', type);
                try {
                    const prefix = type === 'schedule' ? 'schedule-' : type === 'event' ? 'event-' : type === 'leave-' ? 'leave-' : 'request-leave-';
                    const staffInput = document.getElementById(`${prefix}staff`);
                    const titleInput = document.getElementById(`${prefix}title`);
                    const dateInput = document.getElementById(`${prefix}date`);
                    const timeInput = document.getElementById(`${prefix}time`);
                    const taskInput = document.getElementById(`${prefix}task`);
                    const locationInput = document.getElementById(`${prefix}location`);
                    const startDateInput = document.getElementById(`${prefix}start-date`);
                    const endDateInput = document.getElementById(`${prefix}end-date`);
                    const reasonInput = document.getElementById(`${prefix}reason`);

                    if (staffInput) staffInput.value = '';
                    if (titleInput) titleInput.value = '';
                    if (dateInput) dateInput.value = '';
                    if (timeInput) timeInput.value = '';
                    if (taskInput) taskInput.value = '';
                    if (locationInput) locationInput.value = '';
                    if (startDateInput) startDateInput.value = '';
                    if (endDateInput) endDateInput.value = '';
                    if (reasonInput) reasonInput.value = '';
                } catch (error) {
                    console.error('Error in clearForm:', error);
                }
            };
        } else {
            // Fallback for non-Firebase functionality
            window.login = function() {
                console.log('Login button clicked');
                alert('Authentication is currently unavailable. Please try again later.');
            };
            window.signUp = function() {
                console.log('Sign Up button clicked');
                alert('Account creation is currently unavailable. Please try again later.');
            };
            window.logout = function() {
                console.log('Logout button clicked');
                alert('Logout is currently unavailable. Please try again later.');
            };
            window.addSchedule = function() {
                console.log('Add schedule clicked');
                alert('Adding schedules is currently unavailable. Please try again later.');
            };
            window.addEvent = function() {
                console.log('Add event clicked');
                alert('Adding events is currently unavailable. Please try again later.');
            };
            window.addLeave = function() {
                console.log('Add leave clicked');
                alert('Adding leave records is currently unavailable. Please try again later.');
            };
            window.requestLeave = function() {
                console.log('Request leave clicked');
                alert('Requesting leave is currently unavailable. Please try again later.');
            };
            window.editSchedule = function() {
                console.log('Edit schedule clicked');
                alert('Editing schedules is currently unavailable. Please try again later.');
            };
            window.deleteSchedule = function() {
                console.log('Delete schedule clicked');
                alert('Deleting schedules is currently unavailable. Please try again later.');
            };
            window.editEvent = function() {
                console.log('Edit event clicked');
                alert('Editing events is currently unavailable. Please try again later.');
            };
            window.deleteEvent = function() {
                console.log('Delete event clicked');
                alert('Deleting events is currently unavailable. Please try again later.');
            };
            window.editLeave = function() {
                console.log('Edit leave clicked');
                alert('Editing leave records is currently unavailable. Please try again later.');
            };
            window.deleteLeave = function() {
                console.log('Delete leave clicked');
                alert('Deleting leave records is currently unavailable. Please try again later.');
            };
            window.clearForm = function() {
                console.log('Clear form clicked');
                alert('Clearing forms is currently unavailable. Please try again later.');
            };
        }
    </script>
</body>
</html>